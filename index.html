<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Route 66: Health Disparities Along Boston's Bus Route</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/scrollama"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <!-- SortableJS for drag-and-drop reordering -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
</head>
<body>
  <div id="map"></div>
  <div id="story">
    <div id="intro">
      <h1>Boston's Route 66: A Journey Through Health Disparities</h1>
      <p>Travel from Harvard Square to Nubian Square along Boston's MBTA Route 66, where life expectancy varies by nearly 20 years between the wealthiest and poorest neighborhoods.</p>
      <p>Scroll down to explore the route through photos and data.</p>
    </div>
    <div id="scrolly">
      <div id="graphic"></div>
    </div>
  </div>

  <div id="control-panel">
    <button id="toggle-edit">Customize Order</button>
    <button id="add-text-box">Add Text Box</button>
    <div id="order-editor" style="display: none;">
      <p>Drag photos to reorder:</p>
      <div id="sortable-list"></div>
      <button id="save-order">Save Order</button>
      <button id="cancel-edit">Cancel</button>
    </div>
  </div>
  
  <!-- Modal for adding text boxes -->
  <div id="text-box-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Add New Text Box</h2>
      <form id="text-box-form">
        <div class="form-group">
          <label for="text-title">Title:</label>
          <input type="text" id="text-title" required>
        </div>
        <div class="form-group">
          <label for="text-content">Content:</label>
          <textarea id="text-content" rows="5" required></textarea>
        </div>
        <div class="form-group">
          <label for="text-lat">Latitude:</label>
          <input type="number" id="text-lat" step="0.0000001" required>
        </div>
        <div class="form-group">
          <label for="text-lng">Longitude:</label>
          <input type="number" id="text-lng" step="0.0000001" required>
        </div>
        <button type="button" id="submit-text-box">Add Text Box</button>
      </form>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    // Add code for the order customization interface
    document.getElementById('toggle-edit').addEventListener('click', function() {
      const orderEditor = document.getElementById('order-editor');
      if (orderEditor.style.display === 'none') {
        orderEditor.style.display = 'block';
        
        // Populate the sortable list with current photo order
        const sortableList = document.getElementById('sortable-list');
        sortableList.innerHTML = '';
        
        customOrder.forEach((index, position) => {
          if (photoData[index]) {
            const item = document.createElement('div');
            item.className = 'sortable-item';
            item.setAttribute('data-index', index);
            
            // Determine if this is a text box or image
            const isTextBox = photoData[index].filename.includes('text_');
            
            if (isTextBox) {
              item.innerHTML = `
                <div class="text-icon">Txt</div>
                <span>${photoData[index].title || 'Text Box'}</span>
              `;
            } else {
              item.innerHTML = `
                <img src="assets/img/${photoData[index].filename.trim()}" width="50" height="50" style="object-fit: cover; margin-right: 10px;">
                <span>${photoData[index].filename.replace(/\.[^/.]+$/, "").replace(/_/g, " ")}</span>
              `;
            }
            
            sortableList.appendChild(item);
          }
        });
        
        // Initialize sortable
        new Sortable(sortableList, {
          animation: 150,
          ghostClass: 'sortable-ghost'
        });
      } else {
        orderEditor.style.display = 'none';
      }
    });
    
    // Save the new order
    document.getElementById('save-order').addEventListener('click', function() {
      const items = document.querySelectorAll('.sortable-item');
      const newOrder = Array.from(items).map(item => parseInt(item.getAttribute('data-index')));
      
      reorderPhotos(newOrder);
      document.getElementById('order-editor').style.display = 'none';
    });
    
    // Cancel editing
    document.getElementById('cancel-edit').addEventListener('click', function() {
      document.getElementById('order-editor').style.display = 'none';
    });
    
    // Text box modal setup
    const modal = document.getElementById('text-box-modal');
    const addTextBtn = document.getElementById('add-text-box');
    const closeBtn = document.querySelector('.close');
    const submitBtn = document.getElementById('submit-text-box');
    
    // Open modal
    addTextBtn.addEventListener('click', function() {
      modal.style.display = 'block';
      
      // If a point is active, use its coordinates as default
      if (activeElement) {
        const lat = activeElement.getAttribute('data-lat');
        const lng = activeElement.getAttribute('data-lng');
        if (lat && lng) {
          document.getElementById('text-lat').value = lat;
          document.getElementById('text-lng').value = lng;
        }
      }
    });
    
    // Close modal
    closeBtn.addEventListener('click', function() {
      modal.style.display = 'none';
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    });
    
    // Submit text box
    submitBtn.addEventListener('click', addTextBox);
  </script>
</body>
</html>
